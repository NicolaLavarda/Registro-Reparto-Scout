<script>
    const avviaBtn = document.getElementById('avviaBtn');
    const statusLog = document.getElementById('statusLog');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    // Seleziona la nuova checkbox
    const soloEGCb = document.getElementById('soloEGCb');

    function logStatus(message, type = '') {
        const item = document.createElement('div');
        item.textContent = message;
        item.className = 'log-item ' + (type ? 'log-' + type : '');
        statusLog.appendChild(item);
        statusLog.scrollTop = statusLog.scrollHeight; // Auto-scroll
    }

    async function startBulkCreation() {
        avviaBtn.disabled = true;
        avviaBtn.textContent = 'In Corso...';
        statusLog.innerHTML = '';
        progressContainer.style.display = 'none'; // Nasconde la barra all'inizio

        // Determina l'argomento per getRagazziList
        // Se la checkbox è SELEZIONATA (true), passiamo false (per avere solo gli EG presenti)
        // Se la checkbox è DESELEZIONATA (false), passiamo true (per avere TUTTI gli EG, compresi i non presenti)
        const includeAll = !soloEGCb.checked;
        logStatus(`Recupero elenco ragazzi (Includi Tutti: ${includeAll ? 'Sì' : 'No'})...`);

        try {
            const ragazzi = await new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(resolve)
                    .withFailureHandler(reject)
                    .getRagazziList(includeAll); // Passa l'argomento basato sulla checkbox
            });

            if (!ragazzi || ragazzi.length === 0) {
                logStatus('Nessun ragazzo trovato.', 'error');
                avviaBtn.textContent = 'Nessun Ragazzo';
                return;
            }

            const totalRagazzi = ragazzi.length;
            progressContainer.style.display = 'block'; // Mostra la barra
            progressBar.style.width = '0%';
            progressText.textContent = `0 / ${totalRagazzi}`;

            logStatus(`Trovati ${totalRagazzi} ragazzi. Inizio il processo...`);

            let successCount = 0;
            let errorCount = 0;
            let completedCount = 0;

            for (const ragazzo of ragazzi) {
                const id = ragazzo[0];
                const nome = ragazzo[1];
                logStatus(`- Creazione per ${nome}...`);

                try {
                    const result = await new Promise((resolve, reject) => {
                        google.script.run
                            .withSuccessHandler(resolve)
                            .withFailureHandler(reject)
                            .creaReportInDoc(id);
                    });

                    if (result.success) {
                        logStatus(`  -> OK: ${nome}`, 'success');
                        successCount++;
                    } else {
                        throw new Error(result.message);
                    }

                } catch (err) {
                    logStatus(`  -> ERRORE: ${nome} - ${err.message}`, 'error');
                    errorCount++;
                } finally {
                    completedCount++;
                    const percentage = (completedCount / totalRagazzi) * 100;
                    progressBar.style.width = percentage + '%';
                    progressText.textContent = `${completedCount} / ${totalRagazzi}`;
                }
            }

            logStatus('------------------------------------');
            logStatus(`PROCESSO COMPLETATO!`, 'success');
            logStatus(`Report creati/aggiornati: ${successCount}`);
            if (errorCount > 0) {
                logStatus(`Errori riscontrati: ${errorCount}`, 'error');
            }

        } catch (err) {
            logStatus('Errore critico nel recuperare la lista dei ragazzi: ' + (err.message || err), 'error');
            console.error(err);
        } finally {
            avviaBtn.disabled = false;
            avviaBtn.textContent = 'Avvia di Nuovo';
        }
    }

    avviaBtn.addEventListener('click', startBulkCreation);
</script>