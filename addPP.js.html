<script>
    const nameToId = {};

    // Funzione per mostrare messaggi di stato
    function showStatus(message, isSuccess = true) {
        const statusMessage = document.getElementById('statusMessage');
        statusMessage.textContent = message;
        statusMessage.style.color = isSuccess ? '#4CAF50' : '#f44336';
        statusMessage.style.display = 'inline';
        setTimeout(() => {
            statusMessage.style.display = 'none';
        }, 3000);
    }

    // Popola datalist dei ragazzi
    window.onload = function() {
        google.script.run.withSuccessHandler(function(data) {
            const datalist = document.getElementById('ragazziList');
            datalist.innerHTML = '';
            data.forEach(row => {
                if (row[1]) {
                    const fullName = row[1].trim();
                    const opt = document.createElement('option');
                    opt.value = fullName;
                    datalist.appendChild(opt);
                    nameToId[fullName] = row[0]; // mappa Nome -> ID
                }
            });
        }).getRagazziList();
    };

    // Aggiorna campo nascosto ragazzo
    document.getElementById('ragazzoInput').addEventListener('input', function() {
        const inputValue = this.value.trim();
        document.getElementById('ragazzoId').value = nameToId[inputValue] || "";
    });

    /**
     * @param {boolean} keepRagazzo -> mantiene il ragazzo selezionato
     * @param {boolean} keepData -> mantiene la data selezionata
     */
    function salvaDati(keepRagazzo, keepData) {
        const ragazzoInput = document.getElementById('ragazzoInput');
        const ragazzoId = document.getElementById('ragazzoId').value;
        const PPText = document.getElementById('PP').value.trim();
        const dataValue = document.getElementById('data').value;
        const buttons = document.querySelectorAll('input[type="button"]');

        if (!ragazzoId) {
            showStatus("Seleziona un ragazzo valido dalla lista.", false);
            return;
        }
        if (!PPText) {
            showStatus("Inserisci il testo della PP.", false);
            return;
        }

        const data = {
            ragazzo: ragazzoId,
            PP: PPText,
            data: dataValue
        };

        buttons.forEach(b => b.disabled = true);
        showStatus("Salvataggio in corso...", true);

        google.script.run
            .withSuccessHandler(function() {
                const checkmark = document.getElementById('checkmark');
                checkmark.style.display = 'inline';
                showStatus("Salvataggio completato!", true);

                setTimeout(() => {
                    checkmark.style.display = 'none';
                    buttons.forEach(b => b.disabled = false);

                    // Svuota solo il testo del campo PP
                    document.getElementById('PP').value = "";

                    // Gestione reset form
                    if (!keepRagazzo) {
                        ragazzoInput.value = "";
                        document.getElementById('ragazzoId').value = "";
                    }
                    if (!keepData) {
                        document.getElementById('data').value = "";
                    }
                }, 2000);
            })
            .withFailureHandler(function(err) {
                console.error('Errore addPP:', err);
                showStatus("Errore salvataggio PP.", false);
                buttons.forEach(b => b.disabled = false);
            })
            .addPP(data);
    }
</script>