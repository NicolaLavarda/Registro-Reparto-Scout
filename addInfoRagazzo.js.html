<script>
    const nameToId = {};
    let allIncarichi = []; // Variabile per conservare la lista completa degli incarichi

    // Funzione helper per popolare le select
    function populateSelect(selectId, options, placeholder) {
      const select = document.getElementById(selectId);
      select.innerHTML = `<option value="">-- ${placeholder} --</option>`;
      options.forEach(optValue => {
        const opt = document.createElement('option');
        opt.value = optValue;
        opt.textContent = optValue;
        select.appendChild(opt);
      });
    }

    // Funzione per aggiornare le opzioni del secondo incarico
    function updateSecondIncaricoOptions() {
        const firstValue = document.getElementById('incarico').value;
        const secondSelect = document.getElementById('incarico2');
        const currentValue = secondSelect.value; // Salva la selezione corrente per ripristinarla se possibile

        const availableOptions = allIncarichi.filter(opt => opt !== firstValue);
        populateSelect('incarico2', availableOptions, 'Seleziona Incarico');

        // Se la selezione precedente è ancora valida, la ripristina
        if (availableOptions.includes(currentValue)) {
            secondSelect.value = currentValue;
        }
    }


    // Carica tutti i dati all'avvio
    window.onload = function() {
      google.script.run.withSuccessHandler(data => {
        const datalist = document.getElementById('ragazziList');
        datalist.innerHTML = '';
        data.forEach(row => {
          if(row[1]) {
            const fullName = row[1].trim();
            const opt = document.createElement('option');
            opt.value = fullName;
            datalist.appendChild(opt);
            nameToId[fullName] = row[0]; // Mappa Nome -> ID
          }
        });
      }).getRagazziList();

      google.script.run.withSuccessHandler(tappe => populateSelect('tappa', tappe, 'Seleziona Tappa')).getTappe();
      google.script.run.withSuccessHandler(squadriglie => populateSelect('squadriglia', squadriglie, 'Seleziona Squadriglia')).getSquadriglie();
      google.script.run.withSuccessHandler(ruoli => populateSelect('ruolo', ruoli, 'Seleziona Ruolo')).getRuoli();

      google.script.run.withSuccessHandler(incarichi => {
        allIncarichi = incarichi; // Salva la lista completa
        populateSelect('incarico', incarichi, 'Seleziona Incarico');
      }).getIncarichi();

      // Listener per mostrare il secondo campo incarico
      document.getElementById('add-second-incarico-link').addEventListener('click', function(e) {
          e.preventDefault();
          this.style.display = 'none';
          document.getElementById('second-incarico-container').style.display = 'flex';
          updateSecondIncaricoOptions(); // Popola la select quando viene mostrata
      });

      // Listener per aggiornare il secondo campo quando il primo cambia
      document.getElementById('incarico').addEventListener('change', updateSecondIncaricoOptions);
    };

    // Aggiorna campo nascosto con l'ID del ragazzo
    document.getElementById('ragazzoInput').addEventListener('input', function() {
      const inputValue = this.value.trim();
      document.getElementById('ragazzoId').value = nameToId[inputValue] || "";
    });

    function salvaDati(button, keepRagazzo) {
      const form = document.getElementById('form');
      const ragazzoId = document.getElementById('ragazzoId').value;
      const anno = document.getElementById('anno').value;

      if (!ragazzoId) {
        alert("Seleziona un ragazzo valido dalla lista.");
        return;
      }

      if (anno != "" && (anno < 1 || anno > 4)) {
        alert("L'anno dev'essere compreso tra 1 e 4.");
        return;
      }

      // Concatena gli incarichi
      const incarico1 = form.incarico.value.trim();
      const incarico2 = form.incarico2.value.trim();
      let incaricoFinale = incarico1;
      if (incarico1 && incarico2) {
          incaricoFinale = `${incarico1}, ${incarico2}`;
      } else if (incarico2) {
          incaricoFinale = incarico2;
      }

      const formData = {
        ragazzo: ragazzoId,
        anno: anno,
        tappa: form.tappa.value,
        squadriglia: form.squadriglia.value,
        ruolo: form.ruolo.value,
        incarico: incaricoFinale, // Usa il valore concatenato
        nota: form.nota.value,
        data: form.data.value
      };

      // Disabilita entrambi i bottoni
      const buttons = document.querySelectorAll('input[type="button"]');
      buttons.forEach(b => b.disabled = true);

      google.script.run
        .withSuccessHandler(function() {
          document.getElementById('checkmark').style.display = 'inline';

          setTimeout(() => {
            document.getElementById('checkmark').style.display = 'none';
            buttons.forEach(b => b.disabled = false);

            // Pulisci i campi, tranne il ragazzo se specificato
            form.anno.value = "";
            form.tappa.value = "";
            form.squadriglia.value = "";
            form.ruolo.value = "";
            form.incarico.value = "";
            form.nota.value = "";
            form.data.value = "";

            // Nascondi e resetta il secondo campo incarico
            document.getElementById('second-incarico-container').style.display = 'none';
            form.incarico2.value = "";
            document.getElementById('add-second-incarico-link').style.display = 'block';

            if (!keepRagazzo) {
              form.ragazzoInput.value = "";
              form.ragazzoId.value = "";
            }
          }, 2000);
        })
        .withFailureHandler(function(err){
          alert('Si è verificato un errore durante il salvataggio: ' + err.message);
          buttons.forEach(b => b.disabled = false);
        })
        .addInfoRagazzo(formData);
    }
</script>