<script>
    let temaToId = {}; // Nuova mappa per Tema -> ID
    const modeSwitcher = document.getElementById('modeSwitcher');
    const viewBtn = document.getElementById('viewBtn');
    const editBtn = document.getElementById('editBtn');
    let currentMode = 'view';
    let currentConsiglioId = null;

    function showStatus(message, isSuccess = true) {
        const statusMessage = document.getElementById('statusMessage');
        statusMessage.textContent = message;
        statusMessage.style.color = isSuccess ? '#4CAF50' : '#f44336';
        statusMessage.style.display = 'block';
        setTimeout(() => {
            statusMessage.style.display = 'none';
        }, 3000);
    }

    // Funzione per mostrare/nascondere le icone
    function toggleIconsVisibility() {
        const icons = document.querySelectorAll('.icon.edit, .icon.delete');
        icons.forEach(icon => {
            icon.style.display = currentMode === 'edit' ? 'inline-block' : 'none';
        });
    }

    // Funzione per cambiare modalità
    function toggleMode(mode) {
        currentMode = mode;
        viewBtn.classList.remove('active');
        editBtn.classList.remove('active');
        document.getElementById(mode + 'Btn').classList.add('active');
        if (currentConsiglioId) {
            toggleIconsVisibility();
        }
    }

    // Popolamento iniziale della lista consigli
    google.script.run.withSuccessHandler(function(data) {
        const datalist = document.getElementById('consigliList');
        datalist.innerHTML = '';
        temaToId = {}; // Pulisce la mappa prima di riempirla
        data.forEach(row => {
            const id = row[0];
            const tema = row[1] || "";
            if (tema) {
                const opt = document.createElement('option');
                opt.value = tema; // Il valore ora è solo il tema
                datalist.appendChild(opt);
                temaToId[tema] = id; // Popola la nuova mappa
            }
        });
    }).withFailureHandler(function(err) {
        console.error('Errore getConsigliList:', err);
        showStatus('Errore nel caricamento della lista dei consigli.', false);
    }).getConsigliList();

    function mostraRegistro(forceReload = false) {
        let id;
        if (forceReload) {
          id = currentConsiglioId;
        } else {
          const temaSelezionato = document.getElementById('consiglioInput').value.trim();
          if (!temaSelezionato) {
              showStatus("Seleziona un consiglio dalla lista!", false);
              return;
          }

          id = temaToId[temaSelezionato]; // Ottiene l'ID dalla mappa usando il tema
          if (!id) {
              showStatus("Consiglio non trovato! Assicurati di selezionarne uno valido.", false);
              return;
          }
          currentConsiglioId = id; // Salva l'id corrente
        }

        if (!id) return;

        const mostraBtn = document.querySelector("#selezione button:first-of-type");
        if (!forceReload) {
          mostraBtn.disabled = true;
          mostraBtn.textContent = 'Caricamento...';
        }

        google.script.run
            .withSuccessHandler(function(data) {
                if (!forceReload) {
                  mostraBtn.disabled = false;
                  mostraBtn.textContent = 'Mostra';
                }
                generaReport(data);
                showStatus('Report caricato con successo!', true);
            })
            .withFailureHandler(function(err) {
                console.error('Errore getReportConsiglioData:', err);
                if (!forceReload) {
                  mostraBtn.disabled = false;
                  mostraBtn.textContent = 'Mostra';
                }
                showStatus('Errore nel recupero del report del consiglio.', false);
            })
            .getReportConsiglioData(id);
    }

    function generaReport(data) {
        if (!data) {
            showStatus("Errore: dati del consiglio non ricevuti!", false);
            return;
        }

        document.getElementById('reportDisplayArea').style.display = 'block';
        modeSwitcher.style.display = 'flex'; // Mostra il selettore

        const contenuto = document.getElementById('contenuto');
        contenuto.innerHTML = '';

        document.getElementById('titoloConsiglio').textContent = data.titoloConsiglio;
        document.getElementById('dataConsiglio').textContent = `Consiglio del ${data.dataConsiglio}`;

        const squadriglie = data.squadriglie;
        if (!squadriglie || Object.keys(squadriglie).length === 0) {
            contenuto.innerHTML = "<div class='card'><p class='no-data'>Nessun intervento registrato.</p></div>";
            return;
        }

        for (const sq in squadriglie) {
            const card = document.createElement('div');
            card.classList.add('card');

            const h2 = document.createElement('h2');
            h2.textContent = sq;
            card.appendChild(h2);

            const ragazzi = squadriglie[sq]; // ora è un array ordinato
            ragazzi.forEach(ragazzo => {
                const h3 = document.createElement('h3');
                h3.textContent = ragazzo.nomeCompleto;
                card.appendChild(h3);

                const interventi = ragazzo.interventi;
                const ul = document.createElement('ul');
                if (!interventi || interventi.length === 0) {
                    const li = document.createElement('li');
                    li.textContent = "Nessun intervento registrato";
                    li.classList.add('no-data');
                    ul.appendChild(li);
                } else {
                    interventi.forEach(intervento => {
                        const editIcon = `<span class="icon edit" onclick="editIntervento('${intervento.id}')" title="Modifica intervento">&#9998;</span>`;
                        const deleteIcon = `<span class="icon delete" onclick="deleteIntervento('${intervento.id}')" title="Elimina intervento">&#128465;</span>`;

                        const li = document.createElement('li');
                        li.innerHTML = `
                            <div class="item-row">
                                <div class="item-text">${intervento.testo}</div>
                                <div>
                                    ${editIcon}
                                    ${deleteIcon}
                                </div>
                            </div>`;
                        ul.appendChild(li);
                    });
                }
                card.appendChild(ul);
            });
            contenuto.appendChild(card);
        }
        // Applica la visibilità delle icone dopo aver generato il report
        toggleIconsVisibility();
    }

    function editIntervento(id) {
        google.script.run.withSuccessHandler(data => {
            const nuovoTesto = prompt('Modifica l\'intervento:', data.intervento);
            if (nuovoTesto !== null && nuovoTesto.trim() !== "") {
                google.script.run
                    .withSuccessHandler(() => {
                        showStatus("Intervento aggiornato con successo!");
                        mostraRegistro(true); // ricarica il report
                    })
                    .withFailureHandler(err => {
                        console.error("Errore aggiornamento intervento: ", err);
                        showStatus("Errore nell'aggiornamento dell'intervento.", false);
                    })
                    .editIntervento({ id: id, intervento: nuovoTesto });
            }
        }).withFailureHandler(err => {
             console.error("Errore recupero intervento: ", err);
             showStatus("Errore nel recupero dei dati dell'intervento.", false);
        }).getInterventoById(id);
    }

    function deleteIntervento(id) {
        if (confirm("Sei sicuro di voler eliminare questo intervento?")) {
            google.script.run
                .withSuccessHandler(() => {
                    showStatus("Intervento eliminato con successo!");
                    mostraRegistro(true); // ricarica il report
                })
                .withFailureHandler(err => {
                    console.error("Errore eliminazione intervento: ", err);
                    showStatus("Errore durante l'eliminazione.", false)
                })
                .deleteIntervento(id);
        }
    }

    function esportaDocumento() {
        const titolo = document.getElementById('titoloConsiglio').textContent;
        if (!titolo) {
            showStatus("Carica prima un report da esportare.", false);
            return;
        }
        const data = document.getElementById('dataConsiglio').textContent;

        // Creiamo una copia del contenuto e rimuoviamo le icone
        const contenutoNode = document.getElementById('contenuto').cloneNode(true);
        contenutoNode.querySelectorAll('.icon.edit, .icon.delete').forEach(icon => icon.remove());
        const contenutoHtml = contenutoNode.innerHTML;

        const esportaBtn = document.querySelector("#selezione button:last-of-type");
        esportaBtn.disabled = true;
        esportaBtn.textContent = 'Esportazione...';

        google.script.run
            .withSuccessHandler(() => {
                esportaBtn.disabled = false;
                esportaBtn.textContent = 'Esporta Documento';
                showStatus("Documento creato con successo!", true);
            })
            .withFailureHandler(function(err) {
                esportaBtn.disabled = false;
                esportaBtn.textContent = 'Esporta Documento';
                console.error('Errore creaDocumentoGoogle:', err);
                showStatus('Errore durante l\'esportazione del documento.', false);
            })
            .creaDocumentoGoogle(titolo, data, contenutoHtml);
    }

    // Aggiunta listeners per i nuovi pulsanti
    document.addEventListener('DOMContentLoaded', function() {
        viewBtn.addEventListener('click', () => toggleMode('view'));
        editBtn.addEventListener('click', () => toggleMode('edit'));
    });

</script>