<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', Arial, sans-serif;
            margin: 0;
            background-color: #f7f7f7;
            color: #333;
            line-height: 1.6;
        }
        .container {
            padding: 20px;
            box-sizing: border-box;
        }
        .card {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        h1 {
            text-align: center;
            font-size: 2em;
            margin-bottom: 10px;
            color: #333;
        }
        h2 {
            font-size: 1.5em;
            margin-top: 0;
            border-bottom: 2px solid #ddd;
            padding-bottom: 5px;
            color: #444;
        }
        h3 {
            font-size: 1.2em;
            margin-top: 15px;
            margin-bottom: 5px;
            color: #666;
        }
        ul {
            margin-top: 5px;
            margin-bottom: 10px;
            padding-left: 20px;
        }
        li {
            margin-bottom: 4px;
        }
        .non-attivo {
            font-weight: bold;
            color: red;
        }
        .date {
            font-size: 0.8em;
            color: #888;
        }
        .scheda {
            font-size: 0.95em;
        }
        .scheda p {
            margin: 5px 0;
            position: relative;
        }
        .scheda span {
            font-weight: bold;
            color: #222;
        }
        #switchRagazzo {
            text-align: center;
            margin-top: 30px;
        }
        input[type="text"],
        input[list] {
            width: 100%;
            max-width: 300px;
            padding: 10px;
            box-sizing: border-box;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-family: 'Inter', sans-serif;
            font-size: 1em;
            transition: border-color 0.2s;
        }
        input[type="text"]:focus,
        input[list]:focus {
            outline: none;
            border-color: #4CAF50;
        }
        button {
            padding: 10px 15px;
            font-size: 1em;
            border: none;
            border-radius: 0px;
            cursor: pointer;
            font-weight: 700;
            color: white;
            background-color: #4CAF50;
            transition: background-color 0.2s, transform 0.1s;
            margin: 5px;
        }
        button:hover {
            background-color: #45a049;
            transform: translateY(-1px);
        }
        button:active {
            transform: translateY(0);
        }
        button:disabled {
            background-color: #ddd;
            cursor: not-allowed;
        }
        /* Stile specifico per il pulsante Crea Doc */
        #creaDocBtn {
            background-color: #007BFF;
        }
        #creaDocBtn:hover {
            background-color: #0069D9;
        }
        .loading {
            opacity: 0.6;
            cursor: wait;
        }
        .status-message {
            font-weight: 700;
            display: none;
            text-align: center;
            margin-top: 8px;
        }
        .no-data {
            font-style: italic;
            color: #888;
        }
        .icon.edit {
            cursor: pointer;
            color: #999;
            margin-left: 8px;
            font-size: 1.2em;
            vertical-align: middle;
            transition: color 0.2s;
        }

        /* Le icone di modifica e cancellazione sono nascoste di default */
        .icon.edit, .icon.delete {
            display: none;
        }

        .icon:hover {
            color: #4CAF50;
        }
        .icon.delete {
            /* La proprietà 'color' è stata rimossa in modo che l'icona erediti il grigio di default dalla classe .icon */
        }
        .icon.delete:hover {
            color: #f44336; /* L'icona diventa rossa al passaggio del mouse */
        }
        .item-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            gap: 5px;
        }
        .item-text {
            flex: 1;
            word-break: break-word;
            gap: 5px;
        }
        .info-box {
            position: relative;
        }
        .info-box .icon.edit {
            position: absolute;
            bottom: 5px;
            right: 5px;
        }

        .prova-da-notificare {
            color: #d32f2f !important; /* Un rosso scuro e ben visibile */
            font-weight: 700; /* Rende il testo più audace */
        }        
        /* Assicurati che anche il testo interno sia rosso */
        .prova-da-notificare .item-text {
             color: inherit !important;
        }
        .prova-da-notificare .icon {
            /* Reimposta il colore predefinito delle icone (che è #999 per .edit e nulla/ereditato per .delete) */
            /* Usiamo il grigio generico se non è specificato in .icon (vedi riga 126 nel tuo codice originale) */
            color: #999 !important; 
            /* Rimuovi il grassetto forzato da .prova-da-notificare */
            font-weight: normal !important; 
        }
        /* Stili per ripristinare il colore al passaggio del mouse */
        .prova-da-notificare .icon.edit:hover {
            /* Il colore al passaggio del mouse per l'icona Modifica è #4CAF50 */
            color: #4CAF50 !important; 
        }
        .prova-da-notificare .icon.delete:hover {
            /* Il colore al passaggio del mouse per l'icona Elimina è #f44336 */
            color: #f44336 !important; 
        }

        /* Nuovi stili per il selettore "Visualizza/Modifica" */
        #modeSwitcher {
            display: none; /* Inizialmente nascosto */
            justify-content: center;
            margin-bottom: 20px;
        }
        .mode-button {
            background-color: #f0f0f0;
            color: #555;
            border: 1px solid #ccc;
            padding: 8px 16px;
            cursor: pointer;
            font-weight: 700;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        .mode-button:first-child {
            border-radius: 8px 0 0 8px;
            margin-right: 2px; /* Per far combaciare i bordi */
        }
        .mode-button:last-child {
            border-radius: 0 8px 8px 0;
            margin-left: -2px; /* Per far combaciare i bordi */
        }
        .mode-button.active {
            background-color: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }

        /* Nuovi stili per il pulsante di espansione/chiusura Progressione Personale */
        .accordion-button {
            display: flex; /* Allinea testo e icona */
            justify-content: space-between; /* Icona a destra */
            align-items: center;
            width: 100%;
            padding: 10px 0;
            font-size: 1.5em;
            font-weight: 700;
            background-color: transparent; /* Sfondo sempre trasparente */
            border: none;
            border-bottom: 2px solid #ddd; /* Linea grigia sotto il titolo/pulsante */
            padding-bottom: 5px;
            cursor: pointer;
            color: #444;
            text-align: left;
            margin-top: 0;
            margin-bottom: 10px;
            transition: color 0.2s;
        }

        .accordion-button:hover {
            color: #333; /* Leggero scurimento al hover (opzionale, ma mantiene la sobrietà) */
            background-color: transparent; /* NESSUN CAMBIO DI SFONDO */
        }

        .accordion-icon {
            /* Freccia più piccola */
            font-size: 1em; 
            color: #888;
            transition: transform 0.3s ease;
        }

        /* Rotazione dell'icona quando l'accordion è aperto */
        .accordion-button.open .accordion-icon {
            transform: rotate(180deg);
        }

        #PP {
            padding-top: 10px;
        }
        
        #Storico {
            padding-top: 10px;
        }

        /* --- STILI PER PROVE ESPANDIBILI --- */
        .prova-item {
            cursor: pointer;
            transition: background-color 0.2s;
            padding: 4px;
            border-radius: 4px;
        }
        .prova-item:hover {
            background-color: #f9f9f9;
        }
        .prova-details {
            padding: 10px 15px;
            margin-top: 5px;
            background-color: #f8f8f8;
            border-left: 3px solid #4CAF50;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .prova-details p {
            margin: 4px 0;
        }
        .prova-details strong {
            color: #555;
        }
        /* --- FINE STILI PROVE --- */
    </style>
</head>
<body>
    <div class="container">
        <!-- Selettore "Visualizza/Modifica" -->
        <div id="modeSwitcher">
            <button id="viewBtn" class="mode-button active">VISUALIZZA</button>
            <button id="editBtn" class="mode-button">MODIFICA</button>
        </div>
        <div id="reportDisplayArea" style="display: none;">
            <div class="card">
                <h1 id="nomeRagazzo"></h1>
                <div id="schedaRiepilogo" class="scheda"></div>
            </div>

            <div class="card">
                <div id="metaeImpegni"></div>
            </div>

            <div class="card">
                <div id="specialita"></div>
            </div>

            <div class="card" id="PP-container">
                <button id="togglePPBtn" class="accordion-button">
                    Progressione Personale
                    <span class="accordion-icon">▼</span>
                </button>
                <div id="PP" style="display: none;"></div>
            </div>

            <div class="card" id="Storico-container">
                <button id="toggleStoricoBtn" class="accordion-button">
                    Storico
                    <span class="accordion-icon">▼</span>
                </button>
                <div id="Storico" style="display: none;"></div>
            </div>
        </div>

        <div class="card" id="switchRagazzo">
            <p>Visualizza il registro di un altro EG:</p>
            <input list="ragazziList" id="ragazzoInput" placeholder="Scrivi nome e cognome" autocomplete="off">
            <datalist id="ragazziList"></datalist>
            <button id="mostraBtn">Mostra</button>
            <button id="creaDocBtn">Crea Google Doc</button>
            <span id="statusMessage" class="status-message"></span>
        </div>
    </div>

    <script>
        const nameToId = {};
        const mostraBtn = document.getElementById('mostraBtn');
        const ragazzoInput = document.getElementById('ragazzoInput');
        const reportDisplayArea = document.getElementById('reportDisplayArea');
        const modeSwitcher = document.getElementById('modeSwitcher');
        const viewBtn = document.getElementById('viewBtn');
        const editBtn = document.getElementById('editBtn');
        const creaDocBtn = document.getElementById('creaDocBtn');
        let currentRagazzoId;
        let currentMode = 'view';

        function showStatus(message, isSuccess = true) {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.textContent = message;
            statusMessage.style.color = isSuccess ? '#4CAF50' : '#f44336';
            statusMessage.style.display = 'block';
            setTimeout(() => {
                statusMessage.style.display = 'none';
            }, 3000);
        }

        // Funzione per nascondere/mostrare le icone di modifica e cancellazione
        function toggleIconsVisibility() {
            const icons = document.querySelectorAll('.icon.edit, .icon.delete');
            icons.forEach(icon => {
                icon.style.display = currentMode === 'edit' ? 'inline-block' : 'none';
            });
        }
        
        function toggleMode(mode) {
            currentMode = mode;
            viewBtn.classList.remove('active');
            editBtn.classList.remove('active');
            document.getElementById(mode + 'Btn').classList.add('active');
            if (currentRagazzoId) {
                toggleIconsVisibility(); // CHIAMA LA NUOVA FUNZIONE
            }
        }

        // Funzione per espandere/comprimere i dettagli della prova
        function addProvaToggleListeners() {
            document.querySelectorAll('.prova-item').forEach(item => {
                item.addEventListener('click', event => {
                    if (event.target.classList.contains('icon')) {
                        return;
                    }
                    const targetId = item.dataset.target;
                    const detailsDiv = document.getElementById(targetId);
                    if (detailsDiv) {
                        const isHidden = detailsDiv.style.display === 'none';
                        detailsDiv.style.display = isHidden ? 'block' : 'none';
                    }
                });
            });
        }

        function generaReport(data) {
            reportDisplayArea.style.display = 'block';
            modeSwitcher.style.display = 'flex'; // Mostra il selettore dopo il primo report
            creaDocBtn.disabled = false; // Abilita il pulsante per creare il doc
            currentRagazzoId = data.id;

            if (!data) {
                reportDisplayArea.innerHTML = '<div class="card"><h1 style="color:#f44336;">Nessun dato trovato</h1><p style="text-align:center;">Verifica il nome del ragazzo e riprova.</p></div>';
                creaDocBtn.disabled = true; // Disabilita se non ci sono dati
                return;
            }

            const nomeEl = document.getElementById('nomeRagazzo');
            const schedaDiv = document.getElementById('schedaRiepilogo');
            const metaDiv = document.getElementById('metaeImpegni');
            const specDiv = document.getElementById('specialita');
            const ppDiv = document.getElementById('PP');
            const storicoDiv = document.getElementById('Storico');

            nomeEl.textContent = data.nomeCompleto || 'Sconosciuto';

            const annoText = data.anno ? `${data.anno}°` : 'Non registrato';
            const tappaText = data.tappa || 'Non registrata';
            const sqText = data.squadriglia || 'Non registrata';
            const ruoloText = data.ruolo || 'Non registrato';
            const incaricoText = data.incarico || 'Non registrato';

            const editBaseIcon = `<span id="editBaseInfo" class="icon edit" title="Modifica info base">&#9998;</span>`;

            let statoRagazzo = "";
            if (!data.statoRagazzo) {
                statoRagazzo = `<p class="non-attivo">Non è più in Reparto</p>`;
            }

            schedaDiv.innerHTML = `
                <div class="info-box">
                    <p><span>Anno di reparto:</span> ${annoText}</p>
                    <p><span>Tappa:</span> ${tappaText}</p>
                    <p><span>Squadriglia:</span> ${sqText}</p>
                    <p><span>Ruolo di sq:</span> ${ruoloText}</p>
                    <p><span>Incarico di sq:</span> ${incaricoText}</p>
                    ${statoRagazzo}
                    ${editBaseIcon}
                </div>
            `;
            document.getElementById("editBaseInfo").addEventListener("click", () => {
                google.script.run.showAddInfoRagazzo_sub(currentRagazzoId);
            });


            let metaeImpHTML = '<h2>Mete e Impegni</h2>';
            if ((data.mete && data.mete.length > 0) || (data.impegni && data.impegni.length > 0)) {
                if (data.mete && data.mete.length > 0) {
                    metaeImpHTML += '<h3>Mete:</h3><ul>';
                    data.mete.forEach(m => {
                        const editIcon = `<span class="icon edit" onclick="editMetaItem('${m.id}')" title="Modifica meta">&#9998;</span>`;
                        const deleteIcon = `<span class="icon delete" onclick="deleteItem('${m.id}', 'meta')" title="Elimina meta">&#128465;</span>`;
                        metaeImpHTML += `<li>
                            <div class="item-row">
                                <div class="item-text">${m.meta}</div>
                                <span class="date">${m.data}</span>
                                ${editIcon}
                                ${deleteIcon}
                            </div>
                        </li>`;
                    });
                    metaeImpHTML += '</ul>';
                }
                if (data.impegni && data.impegni.length > 0) {
                    metaeImpHTML += '<h3>Impegni:</h3><ul>';
                    data.impegni.forEach(i => {
                        const editIcon = `<span class="icon edit" onclick="editImpegnoItem('${i.id}')" title="Modifica impegno">&#9998;</span>`;
                        const deleteIcon = `<span class="icon delete" onclick="deleteItem('${i.id}', 'impegno')" title="Elimina impegno">&#128465;</span>`;
                        metaeImpHTML += `<li>
                            <div class="item-row">
                                <div class="item-text">${i.impegno}</div>
                                <span class="date">${i.data}</span>
                                ${editIcon}
                                ${deleteIcon}
                            </div>
                        </li>`;
                    });
                    metaeImpHTML += '</ul>';
                }
            } else {
                metaeImpHTML += '<p class="no-data">Nessuna meta o impegno registrato.</p>';
            }
            metaDiv.innerHTML = metaeImpHTML;

            let specHTML = '<h2>Specialità e Brevetti</h2>';
            if (data.specialita && data.specialita.length > 0) {
                data.specialita.forEach(s => {
                    const editIcon = `<span class="icon edit" onclick="editSpecialitaItem('${s.id}')" title="Modifica specialità">&#9998;</span>`;
                    const deleteIcon = `<span class="icon delete" onclick="deleteSpecialita('${s.id}')" title="Elimina specialità">&#128465;</span>`;
                    specHTML += `<div class="item-row">
                        <div class="item-text"><h3>${s.nome}</h3></div>
                        <div>${editIcon}  ${deleteIcon}</div>
                    </div>`;
                    if (Array.isArray(s.prove) && s.prove.length > 0) {
                        specHTML += '<ul>';
                        s.prove.forEach(p => {
                            const daNotificareClass = (p.da_notificare && p.da_notificare.trim().toLowerCase() === 'sì') ? 'prova-da-notificare' : '';
                            const editProvaIcon = `<span class="icon edit" onclick="editProvaItem('${p.id}')" title="Modifica prova">&#9998;</span>`;
                            const deleteProvaIcon = `<span class="icon delete" onclick="deleteProva('${p.id}')" title="Elimina prova">&#128465;</span>`;
                            const detailsId = `details-${p.id}`; // ID unico per i dettagli
                            specHTML += `<li>
                                <div class="item-row prova-item ${daNotificareClass}" data-target="${detailsId}">
                                    <div class="item-text">${p.descrizione}</div>
                                    <span class="date">${p.data}</span>
                                    ${editProvaIcon}
                                    ${deleteProvaIcon}
                                </div>
                                <div id="${detailsId}" class="prova-details" style="display: none;">
                                  ${p.insieme ? `<p><strong>Prova fatta assieme a:</strong> ${p.insieme}</p>` : ''}
                                  ${p.maestro ? `<p><strong>Maestro di Specialità:</strong> ${p.maestro}</p>` : ''}
                                  ${p.nota ? `<p><strong>Note:</strong> ${p.nota}</p>` : ''}
                                  ${p.da_notificare !== "No" ? `<p><strong>Contrassegnato come da notificare:</strong> ${p.da_notificare}</p>` : ''}
                                  <p><strong>Data inserimento:</strong> ${p.data_inserimento || 'data non disponibile'}</p>
                                </div>
                            </li>`;
                        });
                        specHTML += '</ul>';
                    } else {
                        specHTML += '<p class="no-data">Nessuna prova registrata per questa specialità.</p>';
                    }
                });
            } else {
                specHTML += '<p class="no-data">Nessuna specialità o brevetto registrato.</p>';
            }
            specDiv.innerHTML = specHTML;
            addProvaToggleListeners(); // Aggiunge i listener dopo aver creato l'HTML

            let ppHTML = "";
            if (data.PP && data.PP.length > 0) {
                const sortedPP = data.PP.slice().sort((a, b) => b.timestamp - a.timestamp);
                
                let lastDate = null;
                sortedPP.forEach(item => {
                    if (item.dataStr !== lastDate) {
                        if (lastDate !== null) {
                            ppHTML += '</ul>';
                        }
                        ppHTML += `<h3>${item.dataStr}</h3><ul>`;
                        lastDate = item.dataStr;
                    }
                    const editIcon = `<span class="icon edit" onclick="editPP('${item.id}')" title="Modifica progressione">&#9998;</span>`;
                    const deleteIcon = `<span class="icon delete" onclick="deletePP('${item.id}')" title="Elimina progressione">&#128465;</span>`;
                    ppHTML += `<li>
                        <div class="item-row">
                            <div class="item-text">${item.testo}</div>
                            <div>
                                ${editIcon}
                                ${deleteIcon}
                            </div>
                        </div>
                    </li>`;
                });
                if (lastDate !== null) {
                    ppHTML += '</ul>';
                }
            } else {
                ppHTML += '<p class="no-data">Nessuna Progressione Personale registrata.</p>';
            }
            ppDiv.innerHTML = ppHTML;


            let StoricoHTML = "";
            if ( data.storico &&  data.storico.length > 0) {
              let frasi = ["Nuovo anno registrato:", "Nuova tappa data:", "Cambio squadriglia:", "Nuovo ruolo di sq:", "Nuovo incarico:"]
              for (let i = 1; i <= data.maxID_anno; i++) {
                const sortedStorico =  data.storico.slice().filter(el => el.num_id_anno === i).sort((a, b) => a.timestamp - b.timestamp);
                if(sortedStorico.length > 0) {
                  StoricoHTML += `<h3>${sortedStorico[0].anno_titolo}</h3><ul>`;

                  let last_item = new Array(sortedStorico[0].length).fill("");
                  sortedStorico.forEach(item => {
                    for(let k = 0; k < item.info.length; k++) {
                      if(item.info[k] != last_item[k] && item.info[k] != "") {
                        StoricoHTML += `<li>
                            <div class="item-row">
                                <div class="item-text">${frasi[k]} <strong>${item.info[k]}</strong></div>
                                <span class="date">${item.dataStr}</span>
                            </div>
                        </li>`;
                        last_item[k] = item.info[k];
                      }
                    }
                  });

                  StoricoHTML += '</ul>';
                }
              }
            } else {
                StoricoHTML += '<p class="no-data">Nessuna modifica o evento registrato.</p>';
            }
            storicoDiv.innerHTML = StoricoHTML;
            
            toggleIconsVisibility();
        }

        function mostraRegistro(forceReload = false) {
            const nomeRaw = ragazzoInput.value || '';
            const nome = nomeRaw.trim();

            if (!forceReload && (!nome || !nameToId[nome])) {
                showStatus('Inserisci un nome valido o scegli dalla lista.', false);
                return;
            }

            let id = forceReload ? currentRagazzoId : nameToId[nome];
            if (!id) {
                const keys = Object.keys(nameToId);
                const match = keys.find(k => k.toLowerCase() === nome.toLowerCase());
                if (match) {
                    id = nameToId[match];
                } else {
                    showStatus('Ragazzo non trovato! Prova a selezionarlo dalla lista.', false);
                    return;
                }
            }

            if (!forceReload) {
                mostraBtn.disabled = true;
                creaDocBtn.disabled = true;
                mostraBtn.textContent = 'Caricamento...';
                ragazzoInput.classList.add('loading');
                showStatus("Caricamento report...", true);
            }

            google.script.run
                .withSuccessHandler(function(data) {
                    mostraBtn.disabled = false;
                    mostraBtn.textContent = 'Mostra';
                    ragazzoInput.classList.remove('loading');
                    generaReport(data);
                    if (!forceReload) showStatus("Report caricato con successo!", true);
                })
                .withFailureHandler(function(err) {
                    console.error('Errore getReportRagazzoData:', err);
                    mostraBtn.disabled = false;
                    creaDocBtn.disabled = true;
                    mostraBtn.textContent = 'Mostra';
                    ragazzoInput.classList.remove('loading');
                    showStatus('Errore nel recupero del report.', false);
                })
                .getReportRagazzoData(id);
        }

        function popolaDatalist() {
            google.script.run
                .withSuccessHandler(function(rows) {
                    try {
                        const datalist = document.getElementById('ragazziList');
                        datalist.innerHTML = '';
                        if (!rows || !Array.isArray(rows)) return;
                        rows.forEach(row => {
                            if (row && row[1]) {
                                const cognome = row[2] ? (' ' + row[2].trim()) : '';
                                const fullName = row[1].trim() + cognome;
                                const opt = document.createElement('option');
                                opt.value = fullName;
                                datalist.appendChild(opt);
                                nameToId[fullName] = row[0];
                            }
                        });
                    } catch (e) {
                        console.error('Errore nel success handler di getRagazziList:', e);
                        showStatus('Errore nel caricamento della lista dei ragazzi.', false);
                    }
                })
                .withFailureHandler(function(err) {
                    console.error('Errore getRagazziList:', err);
                    showStatus('Errore nel recupero della lista dei ragazzi.', false);
                })
                .getRagazziList(true);
        }
        
        function avviaCreazioneDoc() {
            if (!currentRagazzoId) {
                showStatus('Nessun ragazzo selezionato per creare il documento.', false);
                return;
            }
            creaDocBtn.disabled = true;
            creaDocBtn.textContent = 'Creazione...';
            showStatus('Creazione del documento in corso...', true);

            google.script.run
                .withSuccessHandler(function(response) {
                    creaDocBtn.disabled = false;
                    creaDocBtn.textContent = 'Crea Google Doc';
                    if (response.success) {
                        showStatus(response.message, true);
                    } else {
                        showStatus('Errore: ' + response.message, false);
                    }
                })
                .withFailureHandler(function(err) {
                    creaDocBtn.disabled = false;
                    creaDocBtn.textContent = 'Crea Google Doc';
                    showStatus('Errore imprevisto nella creazione del documento.', false);
                    console.error('Errore creazione doc:', err);
                })
                .creaReportInDoc(currentRagazzoId);
        }

        // Funzioni di modifica e cancellazione
        function editMetaItem(id) {
            google.script.run.withSuccessHandler(data => {
                const nuovoTesto = prompt('Modifica la meta:', data.meta);
                if (nuovoTesto !== null) {
                    const nuovaData = prompt('Modifica la data (opzionale):', data.data);
                    google.script.run
                        .withSuccessHandler(() => {
                            showStatus("Meta aggiornata con successo!");
                            mostraRegistro(true); // ricarica il report
                        })
                        .withFailureHandler(err => showStatus("Errore nell'aggiornamento della meta.", false))
                        .editMeta({ id: id, meta: nuovoTesto, data: nuovaData });
                }
            }).getMetaById(id);
        }

        function editImpegnoItem(id) {
            google.script.run.withSuccessHandler(data => {
                const nuovoTesto = prompt('Modifica l\'impegno:', data.impegno);
                if (nuovoTesto !== null) {
                    const nuovaData = prompt('Modifica la data (opzionale):', data.data);
                    google.script.run
                        .withSuccessHandler(() => {
                            showStatus("Impegno aggiornato con successo!");
                            mostraRegistro(true); // ricarica il report
                        })
                        .withFailureHandler(err => showStatus("Errore nell'aggiornamento dell'impegno.", false))
                        .editImpegno({ id: id, impegno: nuovoTesto, data: nuovaData });
                }
            }).getImpegnoById(id);
        }

        function editSpecialitaItem(id) {
            google.script.run.withSuccessHandler(data => {
                const nuovoTesto = prompt('Modifica la specialità:', data.specialita);
                if (nuovoTesto !== null) {
                    google.script.run
                        .withSuccessHandler(() => {
                            showStatus("Specialità aggiornata con successo!");
                            mostraRegistro(true);
                        })
                        .withFailureHandler(err => showStatus("Errore nell'aggiornamento della specialità.", false))
                        .editSpecialita({ id: id, specialita: nuovoTesto, data: data.data });
                }
            }).getSpecialitaById(id);
        }


        function editProvaItem(id) {
            google.script.run.withSuccessHandler(data => {
                if (!data) {
                    showStatus("Dettagli prova non trovati.", false);
                    return;
                }
                const nuovaDescrizione = prompt('Modifica la descrizione della prova:', data.descrizione || "");
                if (nuovaDescrizione === null) return; // L'utente ha annullato

                const nuovoInsieme = prompt('Prova fatta assieme a (lascia vuoto se da solo):', data.insieme || "");
                if (nuovoInsieme === null) return;

                const nuovoMaestro = prompt('Maestro di Specialità (lascia vuoto se nessuno):', data.maestro || "");
                if (nuovoMaestro === null) return;
                
                const nuovaNota = prompt('Modifica le note:', data.nota || "");
                if (nuovaNota === null) return;

                const isAttualmenteDaNotificare = (data.da_notificare || 'No').trim().toLowerCase() === 'sì';
                const confermaNotifica = confirm('La prova è contrassegnata come "Da notificare"?\n\nPremi OK per "Sì" (Da Notificare) o Annulla per "No" (Non da Notificare).');
                const nuovoDaNotificare = confermaNotifica ? 'Sì' : 'No';
                
                const nuovaData = prompt('Modifica la data (opzionale, formato GG/MM/AAAA):', data.data || "");
                if (nuovaData === null) return;

                // Cerca l'ID corrispondente al nome (case-insensitive) o imposta stringa vuota
                const findIdByName = (name) => {
                    const trimmedName = name.trim();
                    if (!trimmedName) return "";
                    const keyFound = Object.keys(nameToId).find(key => key.toLowerCase() === trimmedName.toLowerCase());
                    return keyFound ? nameToId[keyFound] : "";
                };

                const formData = {
                    id: id,
                    descrizione: nuovaDescrizione.trim(),
                    insieme: nuovoInsieme,
                    maestro: nuovoMaestro,
                    nota: nuovaNota.trim(),
                    da_notificare: nuovoDaNotificare,
                    data: nuovaData.trim()
                };
                
                google.script.run
                    .withSuccessHandler(() => {
                        showStatus("Prova aggiornata con successo!");
                        mostraRegistro(true);
                    })
                    .withFailureHandler(err => showStatus("Errore nell'aggiornamento della prova.", false))
                    .editProva(formData);

            }).getProvaById(id);
        }

        function editPP(id) {
            google.script.run.withSuccessHandler(data => {
                const nuovoTesto = prompt('Modifica la Progressione Personale:', data.PP);
                if (nuovoTesto !== null) {
                    const nuovaData = prompt('Modifica la data (opzionale):', data.data);
                    google.script.run
                        .withSuccessHandler(() => {
                            showStatus("Progressione Personale aggiornata con successo!");
                            mostraRegistro(true);
                        })
                        .withFailureHandler(err => showStatus("Errore nell'aggiornamento della PP.", false))
                        .editPP({ id: id, PP: nuovoTesto, data: nuovaData });
                }
            }).getPPById(id);
        }

        // Funzioni di eliminazione
        function deleteItem(id, type) {
            if (confirm("Sei sicuro di voler eliminare questo elemento?")) {
                google.script.run
                    .withSuccessHandler(() => {
                        showStatus("Elemento eliminato con successo!");
                        mostraRegistro(true);
                    })
                    .withFailureHandler(err => showStatus("Errore nell'eliminazione.", false))
                    [type === 'meta' ? 'deleteMeta' : 'deleteImpegno'](id);
            }
        }

        function deleteSpecialita(id) {
            if (confirm("Sei sicuro di voler eliminare questa specialità e tutte le prove associate?")) {
                google.script.run
                    .withSuccessHandler(() => {
                        showStatus("Specialità eliminata con successo!");
                        mostraRegistro(true);
                    })
                    .withFailureHandler(err => showStatus("Errore nell'eliminazione della specialità.", false))
                    .deleteSpecialita(id);
            }
        }

        function deleteProva(id) {
            if (confirm("Sei sicuro di voler eliminare questa prova?")) {
                google.script.run
                    .withSuccessHandler(() => {
                        showStatus("Prova eliminata con successo!");
                        mostraRegistro(true);
                    })
                    .withFailureHandler(err => showStatus("Errore nell'eliminazione della prova.", false))
                    .deleteProva(id);
            }
        }

        function deletePP(id) {
            if (confirm("Sei sicuro di voler eliminare questa progressione personale?")) {
                google.script.run
                    .withSuccessHandler(() => {
                        showStatus("Progressione Personale eliminata con successo!");
                        mostraRegistro(true);
                    })
                    .withFailureHandler(err => showStatus("Errore nell'eliminazione della PP.", false))
                    .deletePP(id);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            creaDocBtn.disabled = true; // Disabilita all'inizio
            mostraBtn.addEventListener('click', () => mostraRegistro());
            viewBtn.addEventListener('click', () => toggleMode('view'));
            editBtn.addEventListener('click', () => toggleMode('edit'));
            creaDocBtn.addEventListener('click', avviaCreazioneDoc); // Listener per il nuovo pulsante
            popolaDatalist();

            // Gestione toggle PP
            const togglePPBtn = document.getElementById("togglePPBtn");
            const ppDiv = document.getElementById("PP");
            togglePPBtn.addEventListener("click", () => {
                const isOpen = ppDiv.style.display !== "none";
                ppDiv.style.display = isOpen ? "none" : "block";
                togglePPBtn.classList.toggle("open", !isOpen);
            });

            // Gestione toggle Storico
            const toggleStoricoBtn = document.getElementById("toggleStoricoBtn");
            const storicoDiv = document.getElementById("Storico");
            toggleStoricoBtn.addEventListener("click", () => {
                const isOpen = storicoDiv.style.display !== "none";
                storicoDiv.style.display = isOpen ? "none" : "block";
                toggleStoricoBtn.classList.toggle("open", !isOpen);
            });
        });

    </script>
</body>
</html>

