<script>
    const nameToId = {};
    const button = document.getElementById('removeButton');

    // Funzione per mostrare messaggi di stato
    function showStatus(message, isSuccess = true) {
        const statusMessage = document.getElementById('statusMessage');
        statusMessage.textContent = message;
        statusMessage.style.color = isSuccess ? '#4CAF50' : '#f44336';
        statusMessage.style.display = 'inline';
        setTimeout(() => {
            statusMessage.style.display = 'none';
        }, 3000);
    }

    // Popola datalist dei ragazzi
    window.onload = function() {
        google.script.run.withSuccessHandler(function(data) {
            const datalist = document.getElementById('ragazziList');
            datalist.innerHTML = '';
            data.forEach(row => {
                if (row[1]) {
                    const fullName = row[1].trim();
                    const opt = document.createElement('option');
                    opt.value = fullName;
                    datalist.appendChild(opt);
                    nameToId[fullName] = row[0]; // Nome -> ID
                }
            });
        }).getRagazziList();
    };

    // Aggiorna hidden field con l'ID
    document.getElementById('ragazzoInput').addEventListener('input', function() {
        const inputValue = this.value.trim();
        document.getElementById('ragazzoId').value = nameToId[inputValue] || "";
    });

    function remove() {
        button.disabled = true;

        const ragazzoId = document.getElementById('ragazzoId').value;
        if (!ragazzoId) {
            showStatus("Seleziona un ragazzo valido dalla lista.", false);
            button.disabled = false;
            return;
        }

        showStatus("Rimozione in corso...", true);

        google.script.run
            .withSuccessHandler(() => {
                const checkmark = document.getElementById('checkmark');
                checkmark.style.display = 'inline';
                showStatus("Ragazzo segnato come uscito!", true);

                setTimeout(() => {
                    checkmark.style.display = 'none';
                    button.disabled = false;
                    document.getElementById('form').reset();
                }, 2000);
            })
            .withFailureHandler(err => {
                console.error('Errore removeRagazzo:', err);
                showStatus("Errore: " + err.message, false);
                button.disabled = false;
            })
            .removeRagazzo({ ragazzo: ragazzoId });
    }

    button.addEventListener('click', remove);
</script>