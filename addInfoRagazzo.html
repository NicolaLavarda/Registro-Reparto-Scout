<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', Arial, sans-serif;
            margin: 0;
            background-color: #f7f7f7;
            color: #333;
        }

        .container {
            width: 100%;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        label {
            font-weight: 700;
            color: #555;
            display: block;
            margin-bottom: 4px;
        }

        input[type="text"],
        input[type="date"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        input[type="text"]:focus,
        input[type="date"]:focus,
        input[type="number"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #4CAF50;
        }

        textarea {
            resize: vertical;
        }

        .button-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
            align-items: stretch;
        }

        input[type="button"] {
            padding: 12px 18px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 700;
            font-size: 14px;
            color: white;
            background-color: #4CAF50;
            transition: background-color 0.2s, transform 0.1s;
        }

        input[type="button"]:hover {
            background-color: #45a049;
            transform: translateY(-1px);
        }

        input[type="button"]:active {
            transform: translateY(0);
        }

        input[type="button"]:disabled {
            background-color: #ddd;
            cursor: not-allowed;
        }

        #checkmark {
            color: #4CAF50;
            font-size: 24px;
            display: none;
            text-align: center;
        }

        .status-message {
            color: #4CAF50;
            font-weight: 700;
            display: none;
            text-align: center;
            margin-top: 8px;
        }

        #add-second-incarico-link {
            color: grey;
            text-decoration: none;
            font-size: 0.9em;
            cursor: pointer;
            align-self: flex-start;
            margin-top: -8px;
        }
        #add-second-incarico-link:hover {
            text-decoration: underline;
        }
        #second-incarico-container {
            display: none;
            flex-direction: column;
            gap: 12px;
        }
    </style>
</head>
<body>
<div class="container">
  <form id="form">
    <label for="ragazzoInput">Ragazzo:</label>
    <input type="text" id="ragazzoInput" list="ragazziList" placeholder="Digita e seleziona un nome" required>
    <datalist id="ragazziList"></datalist>
    <input type="hidden" id="ragazzoId" name="ragazzo">

    <label for="anno">Anno scout:</label>
    <input type="number" id="anno" name="anno" min="1" max="4">

    <label for="tappa">Tappa:</label>
    <input type="text" id="tappa" name="tappa" list="tappaList" placeholder="Digita e seleziona una tappa">
    <datalist id="tappaList"></datalist>

    <label for="squadriglia">Squadriglia:</label>
    <input type="text" id="squadriglia" name="squadriglia" list="squadrigliaList" placeholder="Digita e seleziona una squadriglia">
    <datalist id="squadrigliaList"></datalist>

    <label for="ruolo">Ruolo:</label>
    <input type="text" id="ruolo" name="ruolo" list="ruoloList" placeholder="Digita e seleziona un ruolo">
    <datalist id="ruoloList"></datalist>

    <label for="incarico">Incarico:</label>
    <input type="text" id="incarico" name="incarico" list="incaricoList" placeholder="Digita e seleziona un incarico">
    <datalist id="incaricoList"></datalist>
    <a id="add-second-incarico-link">+ aggiungi un altro incarico</a>
    
    <div id="second-incarico-container">
        <label for="incarico2">Secondo Incarico:</label>
        <input type="text" id="incarico2" name="incarico2" list="incarico2List" placeholder="Digita e seleziona un incarico">
        <datalist id="incarico2List"></datalist>
    </div>

    <label for="nota">Nota:</label>
    <textarea name="nota" id="nota" rows="3" placeholder="Quale scuola fa? Quali sono i suoi hobby?"></textarea>
    
    <label for="data">Data:</label>
    <input type="date" id="data" name="data">

    <div class="button-container">
      <input type="button" value="Salva" onclick="salvaDati_info_ragazzo(this, false)">
      <span id="checkmark">✔️</span>
    </div>
  </form>
</div>

  <script>
    if (!window._addInfoRagazzoInitialized) {
      window._addInfoRagazzoInitialized = true;

      const nameToId_info_ragazzo = {};
      let allIncarichi_info_ragazzo = [];

      function populateDatalist_info_ragazzo(datalistId, options) {
        const datalist = document.getElementById(datalistId);
        datalist.innerHTML = '';
        options.forEach(optValue => {
          const opt = document.createElement('option');
          opt.value = optValue;
          datalist.appendChild(opt);
        });
      }

      function updateSecondIncaricoOptions_info_ragazzo() {
          const firstValue = document.getElementById('incarico').value;
          const availableOptions = allIncarichi_info_ragazzo.filter(opt => opt !== firstValue);
          populateDatalist_info_ragazzo('incarico2List', availableOptions);
      }

      window.initForm = function initForm() {
        console.log("Entrato in addInfoRagazzo");
        google.script.run.withSuccessHandler(data => {
          const datalist = document.getElementById('ragazziList');
          datalist.innerHTML = '';
          data.forEach(row => {
            if(row[1]) {
              const fullName = row[1].trim();
              const opt = document.createElement('option');
              opt.value = fullName;
              datalist.appendChild(opt);
              nameToId_info_ragazzo[fullName] = row[0];
            }
          });
        }).getRagazziList();

        google.script.run.withSuccessHandler(tappe => populateDatalist_info_ragazzo('tappaList', tappe)).getTappe();
        google.script.run.withSuccessHandler(squadriglie => populateDatalist_info_ragazzo('squadrigliaList', squadriglie)).getSquadriglie();
        google.script.run.withSuccessHandler(ruoli => populateDatalist_info_ragazzo('ruoloList', ruoli)).getRuoli();

        google.script.run.withSuccessHandler(incarichi => {
          allIncarichi_info_ragazzo = incarichi;
          populateDatalist_info_ragazzo('incaricoList', incarichi);
        }).getIncarichi();

        document.getElementById('add-second-incarico-link').addEventListener('click', function(e) {
            e.preventDefault();
            this.style.display = 'none';
            document.getElementById('second-incarico-container').style.display = 'flex';
            updateSecondIncaricoOptions_info_ragazzo();
        });

        document.getElementById('incarico').addEventListener('input', updateSecondIncaricoOptions_info_ragazzo);
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
          try { window.initForm(); } catch(e){ console.error(e); }
        });
      } else {
        try { window.initForm(); } catch(e){ console.error(e); }
      }

      // Aggiorna campo nascosto con l'ID del ragazzo
      document.getElementById('ragazzoInput').addEventListener('input', function() {
        const inputValue = this.value.trim();
        document.getElementById('ragazzoId').value = nameToId_info_ragazzo[inputValue] || "";
      });

      function salvaDati_info_ragazzo(button, keepRagazzo) {
        const form = document.getElementById('form');
        const ragazzoId = document.getElementById('ragazzoId').value;
        const anno = document.getElementById('anno').value;

        if (!ragazzoId) {
          alert("Seleziona un ragazzo valido dalla lista.");
          return;
        }

        if (anno != "" && (anno < 1 || anno > 4)) {
          alert("L'anno dev'essere compreso tra 1 e 4.");
          return;
        }

        // Concatena gli incarichi
        const incarico1 = form.incarico.value.trim();
        const incarico2 = form.incarico2.value.trim();
        let incaricoFinale = incarico1;
        if (incarico1 && incarico2) {
            incaricoFinale = `${incarico1}, ${incarico2}`;
        } else if (incarico2) {
            incaricoFinale = incarico2;
        }

        const formData = {
          ragazzo: ragazzoId,
          anno: anno,
          tappa: form.tappa.value,
          squadriglia: form.squadriglia.value,
          ruolo: form.ruolo.value,
          incarico: incaricoFinale, // Usa il valore concatenato
          nota: form.nota.value,
          data: form.data.value
        };

        // Disabilita entrambi i bottoni
        const buttons = document.querySelectorAll('input[type="button"]');
        buttons.forEach(b => b.disabled = true);

        google.script.run
          .withSuccessHandler(function() {
            document.getElementById('checkmark').style.display = 'inline';
            
            setTimeout(() => {
              document.getElementById('checkmark').style.display = 'none';
              buttons.forEach(b => b.disabled = false);

              // Pulisci i campi, tranne il ragazzo se specificato
              form.anno.value = "";
              form.tappa.value = "";
              form.squadriglia.value = "";
              form.ruolo.value = "";
              form.incarico.value = "";
              form.nota.value = "";
              form.data.value = "";

              // Nascondi e resetta il secondo campo incarico
              document.getElementById('second-incarico-container').style.display = 'none';
              form.incarico2.value = "";
              document.getElementById('add-second-incarico-link').style.display = 'block';

              if (!keepRagazzo) {
                form.ragazzoInput.value = "";
                form.ragazzoId.value = "";
              }
            }, 2000);
          })
          .withFailureHandler(function(err){
            alert('Si è verificato un errore durante il salvataggio: ' + err.message);
            buttons.forEach(b => b.disabled = false);
          })
          .addInfoRagazzo(formData);
      }
    }
  </script>
</body>
</html>
