<script>
    const consiglioToId = {};
    const nameToId = {};
    const buttons = document.querySelectorAll('input[type="button"]'); // Modificato da singola variabile a selezione multipla

    // Funzione per mostrare messaggi di stato
    function showStatus(message, isSuccess = true) {
        const statusMessage = document.getElementById('statusMessage');
        statusMessage.textContent = message;
        statusMessage.style.color = isSuccess ? '#4CAF50' : '#f44336';
        statusMessage.style.display = 'inline';
        setTimeout(() => {
            statusMessage.style.display = 'none';
        }, 3000);
    }

    window.onload = function() {
        // Popola datalist dei consigli
        google.script.run.withSuccessHandler(function(data) {
            const datalist = document.getElementById('consigliList');
            datalist.innerHTML = '';
            data.forEach(row => {
                if (row[1]) {
                    const opt = document.createElement('option');
                    opt.value = row[1].trim();
                    datalist.appendChild(opt);
                    consiglioToId[row[1].trim()] = row[0]; // mappa Tema -> ID
                }
            });
        }).getConsigliList();

        // Popola datalist dei ragazzi
        google.script.run.withSuccessHandler(function(data) {
            const datalist = document.getElementById('ragazziList');
            datalist.innerHTML = '';
            data.forEach(row => {
                if (row[1]) {
                    const fullName = row[1].trim();
                    const opt = document.createElement('option');
                    opt.value = fullName;
                    datalist.appendChild(opt);
                    nameToId[fullName] = row[0]; // mappa Nome -> ID
                }
            });
        }).getRagazziList();
    };

    // Aggiorna campo nascosto consiglio
    document.getElementById('consiglioInput').addEventListener('input', function() {
        const inputValue = this.value.trim();
        document.getElementById('consiglioId').value = consiglioToId[inputValue] || "";
    });

    // Aggiorna campo nascosto ragazzo
    document.getElementById('ragazzoInput').addEventListener('input', function() {
        const inputValue = this.value.trim();
        document.getElementById('ragazzoId').value = nameToId[inputValue] || "";
    });

    // Aggiunge i listener ai pulsanti
    document.getElementById('btnNormale').addEventListener('click', () => salvaDati('normale'));
    document.getElementById('btnNuovoIntervento').addEventListener('click', () => salvaDati('nuovoIntervento'));


    function salvaDati(tipo = 'normale') { // Accetta il tipo di salvataggio come parametro
        const formElement = document.getElementById('form');
        buttons.forEach(b => b.disabled = true);

        const consiglioId = document.getElementById('consiglioId').value;
        const ragazzoId = document.getElementById('ragazzoId').value;
        const interventoText = document.getElementById('intervento').value.trim();
        const dataValue = document.getElementById('data').value;

        if (!consiglioId) {
            showStatus("Seleziona un consiglio valido dalla lista.", false);
            buttons.forEach(b => b.disabled = false);
            return;
        }
        if (!ragazzoId) {
            showStatus("Seleziona un ragazzo valido dalla lista.", false);
            buttons.forEach(b => b.disabled = false);
            return;
        }
        if (!interventoText) {
            showStatus("Inserisci il testo dell'intervento.", false);
            buttons.forEach(b => b.disabled = false);
            return;
        }

        const data = {
            consiglio: consiglioId,
            ragazzo: ragazzoId,
            intervento: interventoText,
            data: dataValue
        };

        showStatus("Salvataggio in corso...", true);

        google.script.run
            .withSuccessHandler(function() {
                const checkmark = document.getElementById('checkmark');
                checkmark.style.display = 'inline';
                showStatus("Salvataggio completato!", true);

                setTimeout(() => {
                    checkmark.style.display = 'none';
                    buttons.forEach(b => b.disabled = false); // Ria abilita tutti i pulsanti

                    switch (tipo) {
                        case 'normale':
                            formElement.reset();
                            document.getElementById('consiglioId').value = "";
                            document.getElementById('ragazzoId').value = "";
                            break;
                        case 'nuovoIntervento':
                            // Resetta solo i campi specifici, mantenendo il Consiglio (id e testo)
                            document.getElementById('ragazzoInput').value = "";
                            document.getElementById('ragazzoId').value = "";
                            document.getElementById('intervento').value = "";
                            document.getElementById('data').value = "";
                            break;
                    }
                }, 2000);
            })
            .withFailureHandler(function(err) {
                console.error('Errore addIntervento:', err);
                showStatus("Errore salvataggio intervento. Controlla log.", false);
                buttons.forEach(b => b.disabled = false);
            })
            .addIntervento(data);
    }
</script>