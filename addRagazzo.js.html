<script>
    const button = document.getElementById('saveButton');
    const nomeField = document.getElementById('nome');
    const cognomeField = document.getElementById('cognome');

    // Funzione per mostrare messaggi di stato
    function showStatus(message, isSuccess = true) {
        const statusMessage = document.getElementById('statusMessage');
        statusMessage.textContent = message;
        statusMessage.style.color = isSuccess ? '#4CAF50' : '#f44336';
        statusMessage.style.display = 'inline';
        setTimeout(() => {
            statusMessage.style.display = 'none';
        }, 3000);
    }

    function salvaDati() {
        button.disabled = true;

        // reset stili errore
        nomeField.classList.remove('error');
        cognomeField.classList.remove('error');

        const formElement = document.getElementById('form');
        const data = {
            nome: nomeField.value.trim(),
            cognome: cognomeField.value.trim(),
        };

        showStatus("Verifica in corso...", true);

        // Controllo duplicati lato server
        google.script.run
            .withSuccessHandler(function(esiste) {
                if (esiste) {
                    showStatus("Questo ragazzo esiste già!", false);
                    nomeField.classList.add('error');
                    cognomeField.classList.add('error');
                    button.disabled = false;

                    formElement.reset();
                    nomeField.classList.remove('error');
                    cognomeField.classList.remove('error');

                    return;
                }

                // Se non esiste duplicato → salva
                showStatus("Salvataggio in corso...", true);
                google.script.run
                    .withSuccessHandler(function() {
                        const checkmark = document.getElementById('checkmark');
                        checkmark.style.display = 'inline';
                        showStatus("Salvataggio completato!", true);

                        formElement.reset();
                        nomeField.classList.remove('error');
                        cognomeField.classList.remove('error');

                        setTimeout(() => {
                            checkmark.style.display = 'none';
                            button.disabled = false;
                        }, 2000);
                    })
                    .withFailureHandler(function(err){
                        console.error('Errore addRagazzo:', err);
                        showStatus('Errore salvataggio ragazzo. Controlla log.', false);
                        button.disabled = false;
                    })
                    .addRagazzo(data);
            })
            .withFailureHandler(function(err) {
                console.error('Errore checkRagazzoExists:', err);
                showStatus('Errore verifica duplicati. Controlla log.', false);
                button.disabled = false;
            })
            .checkRagazzoExists(data.nome, data.cognome);
    }
</script>